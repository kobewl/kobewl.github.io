---
title: "1 Elasticsearch 架构原理"
date: 2023-01-01T01:01:01+08:00
categories: ["D:"]
tags: ["D:"]
draft: false
---
# 1 Elasticsearch 架构原理

## 1.1 集群架构

### 1.1.1 节点类型

1. **Master Node（主节点）**
   - 负责集群状态的管理
   - 维护集群的全局状态
   - 处理创建和删除索引等管理操作
   - 决定分片的分配

2. **Data Node（数据节点）**
   - 存储数据和倒排索引
   - 执行数据相关操作
   - 执行增删改查、聚合等操作

3. **Client Node（客户端节点）**
   - 负责路由请求到其他节点
   - 不存储数据
   - 可以执行本地计算

4. **Coordinating Node（协调节点）**
   - 接收客户端请求并分发到其他节点
   - 汇总各节点返回的数据
   - 每个节点默认都是协调节点

### 1.1.2 节点发现机制

1. **Zen Discovery**
   - 基于 publish/subscribe 模型
   - 支持多播和单播两种方式
   - 通过 ping 确认节点状态

2. **Master选举**
   - 投票选举机制
   - 防止脑裂的最小主节点数配置
   - 自动选举新的主节点

## 1.2 分布式架构

### 1.2.1 分片机制

1. **主分片（Primary Shard）**
   - 索引创建时指定，后续不可更改
   - 决定了索引的容量
   - 分片数的选择考虑因素

2. **副本分片（Replica Shard）**
   - 主分片的拷贝
   - 提供读取的吞吐量
   - 容灾备份

### 1.2.2 路由机制

1. **文档路由**
   - 默认使用文档ID进行hash
   - 可自定义路由规则
   - 保证文档均匀分布

2. **请求路由**
   - 请求到达任意节点
   - 协调节点负责转发
   - 汇总返回结果

## 1.3 写入原理

### 1.3.1 写入流程

1. **客户端请求**
   - 发送写入请求到协调节点
   - 计算目标分片

2. **协调节点处理**
   - 验证请求
   - 路由到主分片

3. **主分片处理**
   - 验证文档
   - 写入内存缓冲区
   - 定期刷新到文件系统缓存

4. **副本同步**
   - 并行复制到副本分片
   - 等待副本确认

### 1.3.2 写入性能优化

1. **批量写入**
   - 使用 bulk API
   - 减少网络开销
   - 提高写入吞吐量

2. **写入缓冲区**
   - 合理设置缓冲区大小
   - 控制刷新频率
   - 权衡实时性和性能

## 1.4 搜索原理

### 1.4.1 搜索流程

1. **Query阶段**
   - 广播查询到所有分片
   - 各分片执行本地搜索
   - 返回文档ID和排序值

2. **Fetch阶段**
   - 协调节点确定要获取的文档
   - 从相关分片获取文档内容
   - 返回最终结果

### 1.4.2 相关性评分

1. **TF/IDF算法**
   - 词频（Term Frequency）
   - 逆文档频率（Inverse Document Frequency）
   - 字段长度归一化

2. **BM25算法**
   - 改进的TF/IDF算法
   - 考虑字段长度的非线性影响
   - 更好的相关性排序

### 1.4.3 搜索性能优化

1. **查询优化**
   - 使用Filter Context
   - 合理使用缓存
   - 避免深度分页

2. **预热缓存**
   - 系统启动时预热
   - 定期执行热门查询
   - 维护查询缓存

## 1.5 故障处理

### 1.5.1 节点故障

1. **主节点故障**
   - 触发主节点选举
   - 更新集群状态
   - 重新分配分片

2. **数据节点故障**
   - 将副本提升为主分片
   - 重新分配副本
   - 恢复数据一致性

### 1.5.2 数据恢复

1. **分片恢复**
   - 从副本恢复
   - 从快照恢复
   - 重建索引

2. **一致性保证**
   - 版本控制
   - 事务日志
   - 定期检查点
