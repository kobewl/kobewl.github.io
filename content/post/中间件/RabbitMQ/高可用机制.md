---
title: "RabbitMQ 高可用机制"
date: 2023-01-01T01:01:01+08:00
categories: ["D:"]
tags: ["D:"]
draft: false
---
# RabbitMQ 高可用机制

## 集群模式

### 普通集群

普通集群（Classic Cluster）模式下，队列的内容仅存在于其创建所在的节点，其他节点只存储队列的元数据。

#### 配置步骤

1. **修改 hosts 文件**

```bash
# /etc/hosts
192.168.0.1 rabbit1
192.168.0.2 rabbit2
192.168.0.3 rabbit3
```

2. **同步 Erlang Cookie**

```bash
# 复制主节点的 .erlang.cookie 到其他节点
scp /var/lib/rabbitmq/.erlang.cookie root@rabbit2:/var/lib/rabbitmq/
scp /var/lib/rabbitmq/.erlang.cookie root@rabbit3:/var/lib/rabbitmq/
```

3. **加入集群**

```bash
# 在从节点上执行
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@rabbit1
rabbitmqctl start_app
```

4. **查看集群状态**

```bash
rabbitmqctl cluster_status
```

### 镜像集群

镜像集群模式下，队列内容会在集群节点间同步，提供数据的冗余备份。

#### 配置方法

1. **通过命令行设置镜像策略**

```bash
# 设置所有队列镜像到所有节点
rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all"}'

# 设置指定队列镜像到指定数量的节点
rabbitmqctl set_policy ha-two "^" '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'
```

2. **通过管理界面设置**

```
Admin -> Policies -> Add policy
Pattern: ^
Definition: ha-mode=all
```

### Quorum 队列

Quorum 队列是 RabbitMQ 3.8+ 版本引入的新特性，基于 Raft 协议实现。

#### 创建 Quorum 队列

```java
Map<String, Object> args = new HashMap<>();
args.put("x-queue-type", "quorum");
channel.queueDeclare("quorum.queue", true, false, false, args);
```

## HAProxy 负载均衡

### 安装配置

1. **安装 HAProxy**

```bash
apt-get install haproxy
```

2. **配置 HAProxy**

```conf
# /etc/haproxy/haproxy.cfg
global
    log 127.0.0.1 local0
    maxconn 4096

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

listen rabbitmq_cluster
    bind *:5672
    mode tcp
    balance roundrobin
    server rabbit1 192.168.0.1:5672 check inter 2000 rise 2 fall 3
    server rabbit2 192.168.0.2:5672 check inter 2000 rise 2 fall 3
    server rabbit3 192.168.0.3:5672 check inter 2000 rise 2 fall 3

listen rabbitmq_admin
    bind *:15672
    mode http
    balance roundrobin
    server rabbit1 192.168.0.1:15672 check inter 2000 rise 2 fall 3
    server rabbit2 192.168.0.2:15672 check inter 2000 rise 2 fall 3
    server rabbit3 192.168.0.3:15672 check inter 2000 rise 2 fall 3
```

## Federation 跨机房数据复制

Federation 插件允许在不同的 RabbitMQ 集群之间传递消息。

### 配置步骤

1. **启用插件**

```bash
rabbitmq-plugins enable rabbitmq_federation
rabbitmq-plugins enable rabbitmq_federation_management
```

2. **配置上游**

```bash
# 添加上游
rabbitmqctl set_parameter federation-upstream my-upstream \
    '{"uri":"amqp://remote-server","expires":3600000}'

# 设置 policy
rabbitmqctl set_policy --apply-to exchanges federation-policy \
    "^federation\." '{"federation-upstream-set":"all"}' --priority 1
```

## Shovel 数据转发

Shovel 插件用于在 RabbitMQ 集群间可靠地转发消息。

### 配置步骤

1. **启用插件**

```bash
rabbitmq-plugins enable rabbitmq_shovel
rabbitmq-plugins enable rabbitmq_shovel_management
```

2. **配置 Shovel**

```bash
# 动态 Shovel
rabbitmqctl set_parameter shovel my-shovel \
    '{"src-uri": "amqp://source-server", "src-queue": "my-queue", \
      "dest-uri": "amqp://dest-server", "dest-queue": "my-queue"}'
```

## 监控与告警

### 关键监控指标

1. **节点状态监控**

```bash
# 查看节点状态
rabbitmqctl node_health_check

# 查看节点资源使用
rabbitmqctl status
```

2. **队列监控**

```bash
# 查看队列状态
rabbitmqctl list_queues name messages_ready messages_unacknowledged
```

3. **连接监控**

```bash
# 查看连接状态
rabbitmqctl list_connections
```

### 告警配置

1. **内存告警**

```bash
# 设置内存告警阈值
rabbitmqctl set_vm_memory_high_watermark 0.4
```

2. **磁盘告警**

```bash
# 设置磁盘告警阈值
rabbitmqctl set_disk_free_limit 2GB
```

## 灾备方案

### 数据备份

1. **定期备份**

```bash
# 备份配置
rabbitmqctl export_definitions backup.json

# 备份消息
rabbitmqadmin export messages.json
```

2. **恢复数据**

```bash
# 恢复配置
rabbitmqctl import_definitions backup.json

# 恢复消息
rabbitmqadmin import messages.json
```

### 故障转移

1. **自动故障转移**

- 使用 Quorum 队列自动处理节点故障
- 配置镜像队列的自动同步

2. **手动故障转移**

```bash
# 将主节点角色转移
rabbitmqctl change_cluster_node_type ram
```

