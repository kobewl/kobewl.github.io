---
title: "Elasticsearch 索引管理"
date: 2023-01-01T01:01:01+08:00
categories: ["D:"]
tags: ["D:"]
draft: false
---
# Elasticsearch 索引管理

## 1. 索引操作

### 1.1 创建索引

1. **基本语法**
```json
PUT /my_index
{
    "settings": {
        "number_of_shards": 3,
        "number_of_replicas": 1
    }
}
```

2. **索引设置项**
   - number_of_shards：主分片数量
   - number_of_replicas：副本数量
   - refresh_interval：刷新间隔
   - analysis：分析器配置

### 1.2 删除索引

1. **删除单个索引**
```json
DELETE /my_index
```

2. **删除多个索引**
```json
DELETE /index1,index2
```

### 1.3 索引设置

1. **动态设置**
   - 可以在运行时修改
   - 包括副本数、刷新间隔等

2. **静态设置**
   - 创建索引时指定
   - 包括分片数、分析器等

### 1.4 索引模板

1. **创建模板**
```json
PUT _template/my_template
{
    "index_patterns": ["test-*"],
    "settings": {
        "number_of_shards": 1
    },
    "mappings": {
        "properties": {
            "name": { "type": "text" }
        }
    }
}
```

2. **模板优先级**
   - 多个模板匹配时的优先级设置
   - 合并规则

## 2. Mapping 管理

### 2.1 字段类型

1. **核心类型**
   - text：全文检索
   - keyword：关键词匹配
   - date：日期类型
   - long/integer/short：数值类型
   - double/float：浮点类型
   - boolean：布尔类型

2. **复杂类型**
   - object：嵌套对象
   - nested：嵌套数组
   - geo_point：地理位置

### 2.2 动态映射

1. **动态映射规则**
   - 字符串字段：自动映射为text和keyword
   - 数值字段：自动判断类型
   - 日期字段：自动识别常见格式

2. **动态映射模板**
```json
PUT my_index
{
    "mappings": {
        "dynamic_templates": [
            {
                "strings_as_keywords": {
                    "match_mapping_type": "string",
                    "mapping": {
                        "type": "keyword"
                    }
                }
            }
        ]
    }
}
```

### 2.3 显式映射

1. **创建映射**
```json
PUT my_index
{
    "mappings": {
        "properties": {
            "title": { 
                "type": "text",
                "analyzer": "standard"
            },
            "tags": {
                "type": "keyword"
            }
        }
    }
}
```

2. **更新映射**
   - 已有字段不能修改类型
   - 可以添加新字段
   - 可以修改字段属性

### 2.4 字段属性设置

1. **常用属性**
   - index：是否创建索引
   - doc_values：是否创建正排索引
   - store：是否存储原始值
   - null_value：空值替换

2. **分析器属性**
   - analyzer：索引分析器
   - search_analyzer：搜索分析器
   - normalizer：归一化器

## 3. 分词器

### 3.1 内置分词器

1. **Standard Analyzer**
   - 默认分词器
   - 按词切分
   - 小写处理

2. **Simple Analyzer**
   - 按非字母切分
   - 小写处理

3. **Whitespace Analyzer**
   - 按空格切分
   - 不做大小写处理

### 3.2 自定义分词器

1. **组成部分**
   - character filters
   - tokenizer
   - token filters

2. **配置示例**
```json
PUT my_index
{
    "settings": {
        "analysis": {
            "analyzer": {
                "my_analyzer": {
                    "type": "custom",
                    "tokenizer": "standard",
                    "filter": ["lowercase", "stop"]
                }
            }
        }
    }
}
```

### 3.3 中文分词器

1. **IK分词器**
   - 支持中文分词
   - 支持热更新词典
   - 支持自定义词典

2. **配置方式**
```json
PUT my_index
{
    "mappings": {
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_smart"
            }
        }
    }
}
```

### 3.4 分词器使用场景

1. **搜索场景**
   - 全文检索：text + standard
   - 精确匹配：keyword
   - 中文检索：ik_max_word/ik_smart

2. **聚合场景**
   - 关键词聚合：keyword
   - 文本分析：text + 自定义分词器
