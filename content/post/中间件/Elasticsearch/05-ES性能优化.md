---
title: "Elasticsearch 性能优化"
date: 2023-01-01T01:01:01+08:00
categories: ["D:"]
tags: ["D:"]
draft: false
---
# Elasticsearch 性能优化

## 1. 索引优化

### 1.1 分片优化

1. **合理的分片数量**
   - 单个分片大小建议在20GB-40GB
   - 分片数量 = 数据总量 / 单个分片大小
   - 考虑预留30%的增长空间

2. **副本配置**
   - 副本数量根据可用性要求配置
   - 副本过多会增加写入压力
   - 建议至少1个副本保证高可用

### 1.2 索引刷新策略

1. **refresh_interval设置**
```json
PUT /my_index/_settings
{
    "index": {
        "refresh_interval": "30s"
    }
}
```
   - 增大刷新间隔减少系统开销
   - 批量导入时可临时关闭自动刷新
   - 权衡实时性和性能

2. **索引缓冲区设置**
```json
PUT /_cluster/settings
{
    "persistent": {
        "indices.memory.index_buffer_size": "20%"
    }
}
```
   - 合理配置缓冲区大小
   - 避免频繁的磁盘IO
   - 监控缓冲区使用情况

## 2. 查询优化

### 2.1 查询设计优化

1. **使用Filter Context**
```json
GET /my_index/_search
{
    "query": {
        "bool": {
            "filter": [
                { "term": { "status": "active" }}
            ]
        }
    }
}
```
   - 对于不需要评分的查询使用filter
   - 利用filter的缓存机制
   - 减少不必要的评分计算

2. **避免深度分页**
   - 使用scroll API处理深度分页
   - 采用search_after进行实时分页
   - 限制from + size的大小

### 2.2 缓存优化

1. **缓存预热**
   - 系统启动时预热重要查询
   - 定期执行热门查询保持缓存
   - 监控缓存命中率

2. **缓存设置**
```json
PUT /my_index/_settings
{
    "index": {
        "queries.cache.enabled": true
    }
}
```
   - 合理配置查询缓存大小
   - 识别和缓存频繁使用的过滤器
   - 避免缓存大量的临时查询

## 3. 系统优化

### 3.1 JVM设置

1. **内存配置**
   - 堆内存设置不超过32GB
   - 预留50%系统内存给操作系统
   - 使用G1GC收集器

2. **GC优化**
   - 监控GC频率和时间
   - 调整新生代和老年代比例
   - 避免频繁的Full GC

### 3.2 磁盘优化

1. **存储配置**
   - 使用SSD提升性能
   - 配置RAID提高可靠性
   - 定期进行磁盘维护

2. **文件系统优化**
   - 使用ext4或XFS文件系统
   - 禁用磁盘缓存
   - 调整系统IO调度器

## 4. 写入优化

### 4.1 批量写入

1. **Bulk API使用**
```json
POST /_bulk
{"index":{"_index":"test","_id":"1"}}
{"field1":"value1"}
{"index":{"_index":"test","_id":"2"}}
{"field1":"value2"}
```
   - 批量提交减少网络开销
   - 控制单次批量大小
   - 并行执行多个批量请求

2. **写入性能调优**
   - 临时关闭副本加快导入
   - 增大refresh_interval
   - 使用自动生成的文档ID

### 4.2 并发控制

1. **乐观并发控制**
```json
PUT /test/_doc/1?if_seq_no=1&if_primary_term=1
{
    "field": "new value"
}
```
   - 使用版本号控制并发
   - 避免写入冲突
   - 实现乐观锁机制

2. **写入限流**
   - 控制写入速率
   - 避免写入峰值
   - 监控写入性能

## 5. 监控与维护

### 5.1 性能监控

1. **关键指标**
   - 查询延迟
   - 索引写入速率
   - 系统资源使用率
   - GC状况

2. **监控工具**
   - Elasticsearch Stats API
   - Kibana监控面板
   - 第三方监控工具

### 5.2 定期维护

1. **索引维护**
   - 定期合并段
   - 清理过期数据
   - 优化索引设置

2. **系统维护**
   - 定期备份数据
   - 升级集群版本
   - 扩展集群规模
