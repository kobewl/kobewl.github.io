---
title: "1 Elasticsearch 查询与聚合"
date: 2023-01-01T01:01:01+08:00
categories: ["D:"]
tags: ["D:"]
draft: false
---
# 1 Elasticsearch 查询与聚合

## 1.1 Query DSL

### 1.1.1 查询类型

1. **Match Query**
```json
GET /my_index/_search
{
    "query": {
        "match": {
            "title": "elasticsearch guide"
        }
    }
}
```
   - 全文检索的标准查询
   - 会对查询文本进行分词
   - 支持相关性评分

2. **Term Query**
```json
GET /my_index/_search
{
    "query": {
        "term": {
            "status": "active"
        }
    }
}
```
   - 精确匹配
   - 不进行分词
   - 适用于关键词、数值等结构化数据

3. **Range Query**
```json
GET /my_index/_search
{
    "query": {
        "range": {
            "age": {
                "gte": 20,
                "lte": 30
            }
        }
    }
}
```
   - 范围查询
   - 支持日期、数值等类型
   - 包含多种范围操作符

4. **Bool Query**
```json
GET /my_index/_search
{
    "query": {
        "bool": {
            "must": [
                { "match": { "title": "search" }}
            ],
            "filter": [
                { "term": { "status": "published" }}
            ],
            "should": [
                { "match": { "description": "elasticsearch" }}
            ],
            "must_not": [
                { "term": { "type": "draft" }}
            ]
        }
    }
}
```
   - 复合查询
   - 组合多个查询条件
   - 支持must、should、must_not、filter

### 1.1.2 相关性评分

1. **评分机制**
   - TF/IDF算法
   - BM25算法
   - 字段长度归一化

2. **自定义评分**
```json
GET /my_index/_search
{
    "query": {
        "function_score": {
            "query": { "match": { "title": "elasticsearch" }},
            "functions": [
                {
                    "field_value_factor": {
                        "field": "popularity",
                        "modifier": "log1p"
                    }
                }
            ]
        }
    }
}
```

## 1.2 Filter Context

### 1.2.1 过滤查询

1. **基本用法**
```json
GET /my_index/_search
{
    "query": {
        "bool": {
            "filter": [
                { "term": { "status": "active" }},
                { "range": { "price": { "gte": 10 }}}
            ]
        }
    }
}
```

2. **优势**
   - 不计算相关性评分
   - 结果可以缓存
   - 执行效率更高

### 1.2.2 缓存机制

1. **Filter缓存**
   - 自动缓存频繁使用的过滤器
   - 缓存采用自适应策略
   - 缓存以位图形式存储

2. **缓存管理**
   - 自动失效机制
   - 内存使用控制
   - 缓存命中率监控

## 1.3 聚合分析

### 1.3.1 Bucket聚合

1. **Terms Aggregation**
```json
GET /my_index/_search
{
    "aggs": {
        "status_count": {
            "terms": { "field": "status" }
        }
    }
}
```
   - 分组统计
   - 支持排序和限制数量
   - 可以嵌套其他聚合

2. **Date Histogram**
```json
GET /my_index/_search
{
    "aggs": {
        "sales_per_month": {
            "date_histogram": {
                "field": "date",
                "calendar_interval": "month"
            }
        }
    }
}
```
   - 时间区间统计
   - 支持多种时间间隔
   - 适合时序数据分析

### 1.3.2 Metric聚合

1. **基础指标**
```json
GET /my_index/_search
{
    "aggs": {
        "avg_price": { "avg": { "field": "price" }},
        "max_price": { "max": { "field": "price" }},
        "sum_price": { "sum": { "field": "price" }}
    }
}
```
   - 平均值、最大值、最小值
   - 总和、计数
   - 统计值（方差、标准差）

2. **高级指标**
   - 百分位数
   - 基数统计
   - 地理位置计算

### 1.3.3 Pipeline聚合

1. **基本用法**
```json
GET /my_index/_search
{
    "aggs": {
        "sales_per_month": {
            "date_histogram": {
                "field": "date",
                "calendar_interval": "month"
            },
            "aggs": {
                "sales": { "sum": { "field": "price" }},
                "sales_deriv": {
                    "derivative": { "buckets_path": "sales" }
                }
            }
        }
    }
}
```

2. **常用Pipeline聚合**
   - 导数聚合
   - 累计总和
   - 移动平均值

## 1.4 排序

### 1.4.1 基本排序

1. **字段排序**
```json
GET /my_index/_search
{
    "sort": [
        { "price": "desc" },
        { "_score": "desc" }
    ]
}
```

2. **多字段排序**
   - 优先级按数组顺序
   - 支持多种排序模式
   - 可以混合使用相关性评分

### 1.4.2 高级排序

1. **脚本排序**
```json
GET /my_index/_search
{
    "sort": {
        "_script": {
            "type": "number",
            "script": {
                "lang": "painless",
                "source": "doc['price'].value * doc['discount'].value"
            },
            "order": "desc"
        }
    }
}
```

2. **地理位置排序**
   - 按距离排序
   - 支持多种距离计算方式
   - 可以结合其他排序条件
